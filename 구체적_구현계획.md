# êµ¬ì²´ì  êµ¬í˜„ ê³„íš: Domain, Infrastructure & Application Layers

## 1. ì‹¤í–‰ í™˜ê²½ ë° í•µì‹¬ ìš”êµ¬ì‚¬í•­ (Runtime Requirements)
ì‚¬ìš©ìê°€ ì •ì˜í•œ ì‹œìŠ¤í…œì˜ ì‘ë™ ë°©ì‹ê³¼ ëª©í‘œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

### A. ë¬´í•œ ë§¤ìˆ˜ ì „ëµ ì‹¤í–‰ ì‚¬ì´í´ (Execution Cycle)
1.  **ì£¼ê¸°**: ë§¤ì¼ ë¯¸êµ­ ì£¼ì‹ ì‹œì¥ í”„ë¦¬ë§ˆì¼“ ê°œì¥ì§í›„ 1íšŒ í•„ìˆ˜ ì‹¤í–‰.
2.  **ì›Œí¬í”Œë¡œìš°**:
    *   `Check State`: ì•± ì‹¤í–‰ ì§í›„, ì €ì¥ëœ ìƒíƒœ(ì‚¬ì´í´ ì§„í–‰ ì •ë³´, ê¸ˆì¼ ì£¼ë¬¸ ì—¬ë¶€)ë¥¼ ë¡œë“œ.
    *   `Decision`:
        *   **Case A (ì´ë¯¸ ì£¼ë¬¸ ì™„ë£Œ)**: ë‹¤ìŒ ë‚  í”„ë¦¬ë§ˆì¼“ ì˜¤í”ˆê¹Œì§€ ëŒ€ê¸°.
        *   **Case B (ë¯¸ì£¼ë¬¸ & í”„ë¦¬ë§ˆì¼“ ì „)**: í”„ë¦¬ë§ˆì¼“ ì˜¤í”ˆ ëŒ€ê¸° í›„ ì˜ˆì•½ ì£¼ë¬¸.
        *   **Case C (ë¯¸ì£¼ë¬¸ & í”„ë¦¬ë§ˆì¼“/ì •ê·œì¥ ì§„í–‰ ì¤‘)**: **ì¦‰ì‹œ ì£¼ë¬¸ ì‹¤í–‰** (ëŠ¦ê²Œë¼ë„ ì£¼ë¬¸ ì²˜ë¦¬).
    *   `Execute`: ê³„ì‚°ëœ ì£¼ë¬¸ì„ ì‹œì¥ì— ì „ì†¡.
    *   `Monitor`: ì¥ ë§ˆê° í›„ ì²´ê²° í™•ì¸ ë° ì‚¬ì´í´ ì¢…ë£Œ ì—¬ë¶€ íŒë‹¨. ì• í”„í„°ë§ˆì¼“ ì£¼ë¬¸ì´ ì‚´ì•„ìˆì„ ê²½ìš° ê³„ì† ëª¨ë‹ˆí„°ë§

### B. ì—°ì†ì„± ë° ë³µêµ¬ (Persistence & Recovery)
*   **Crash Safe**: ì„œë²„ë‚˜ ì•±ì´ ì¬ì‹œì‘ë˜ë”ë¼ë„, ë§ˆì§€ë§‰ ìƒíƒœ(ì˜¤ëŠ˜ ì£¼ë¬¸ì„ í–ˆëŠ”ì§€, í˜„ì¬ ì‚¬ì´í´ ì •ë³´ ë“±)ë¥¼ ì™„ë²½íˆ ë³µêµ¬í•´ì•¼ í•¨.
*   **State File**: ëª¨ë“  í•µì‹¬ ìƒíƒœ ë°ì´í„°ëŠ” ë¡œì»¬ íŒŒì¼(JSON/SQLite)ì— ì¦‰ì‹œ ê¸°ë¡ë˜ì–´ì•¼ í•¨.

### C. ì¸í„°ë™í‹°ë¸Œ ì‹œìŠ¤í…œ (Interactive System)
*   **Notification**: ìƒíƒœ ë³€ê²½(ì£¼ë¬¸ ì‹¤í–‰, ì²´ê²° ì™„ë£Œ, ì—ëŸ¬ ë°œìƒ) ì‹œ **í…”ë ˆê·¸ë¨ ì•Œë¦¼** ì¦‰ì‹œ ì „ì†¡.
*   **Command Control**: í…”ë ˆê·¸ë¨ì„ í†µí•´ ëª…ë ¹ì–´ ìˆ˜ì‹  ë° ì‹¤í–‰.
    *   `/status`: í˜„ì¬ ìƒíƒœ ë° í¬ì§€ì…˜ ì¡°íšŒ
    *   `/force_start`: ê°•ì œ ë§¤ìˆ˜/ë§¤ë„ ì‚¬ì´í´ ì‹¤í–‰
    *   `/stop`: ë´‡ ì¼ì‹œ ì •ì§€

---

## 2. Infrastructure Layer (`src_rev/infrastructure`)

ë„ë©”ì¸ ë¡œì§ì„ ì‹¤ì œ ì„¸ê³„(API, Telegram, FS)ì™€ ì—°ê²°í•˜ëŠ” êµ¬í˜„ì²´ë“¤ì…ë‹ˆë‹¤.

```bash
src_rev/infrastructure/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ kis/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ auth.py         # KIS ì¸ì¦ ì²˜ë¦¬
â”‚   â”œâ”€â”€ api.py          # KIS API í´ë¼ì´ì–¸íŠ¸ (REST)
â”‚   â””â”€â”€ websocket.py    # ì²´ê²° í†µë³´ìš© (ì„ íƒ)
â”œâ”€â”€ messaging/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ telegram_bot.py # í…”ë ˆê·¸ë¨ ì†¡ìˆ˜ì‹  (python-telegram-bot)
â””â”€â”€ persistence/
    â”œâ”€â”€ __init__.py
    â””â”€â”€ state_file.py   # JSON íŒŒì¼ ê¸°ë°˜ ìƒíƒœ ì €ì¥ì†Œ
```

### í•µì‹¬ í´ë˜ìŠ¤: `TelegramBotService`
*   `Application Layer`ì™€ í†µì‹ í•˜ê¸° ìœ„í•´ `Queue`ë‚˜ `Event` ë°©ì‹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë‚˜, ì´ˆê¸°ì—ëŠ” ë‹¨ìˆœí•˜ê²Œ `CommandHandler`ë¥¼ ë“±ë¡í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„.
*   **ë¹„ë™ê¸° ì²˜ë¦¬**: í…”ë ˆê·¸ë¨ ë´‡ì€ ë³„ë„ ìŠ¤ë ˆë“œ/í”„ë¡œì„¸ìŠ¤ì—ì„œ ëŒê±°ë‚˜ `asyncio` ë£¨í”„ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨. `main_rev.py`ì˜ ë©”ì¸ ë£¨í”„ì™€ ê³µì¡´í•´ì•¼ í•˜ë¯€ë¡œ `asyncio` ê¸°ë°˜ ì„¤ê³„ ê¶Œì¥.

---

## 3. Application Layer (`src_rev/application`)

ë„ë©”ì¸ ë¡œì§ê³¼ ì¸í”„ë¼ë¥¼ ì¡°í•©í•˜ì—¬ ì‹¤ì œ ìœ ìŠ¤ì¼€ì´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” ê³³.

```bash
src_rev/application/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ trading_engine.py   # ë©”ì¸ ì‹¤í–‰ ë£¨í”„ (ìŠ¤ì¼€ì¤„ë§, ìƒíƒœ ì²´í¬)
â””â”€â”€ message_handler.py  # í…”ë ˆê·¸ë¨ ëª…ë ¹ì–´ ì²˜ë¦¬ê¸°
```

### ì›Œí¬í”Œë¡œìš° ì˜ˆì‹œ (í…”ë ˆê·¸ë¨ ì—°ë™)
1.  `TradingEngine`ì´ ì£¼ë¬¸ì„ ì‹¤í–‰í•¨ -> `order_executed` ì´ë²¤íŠ¸ ë°œìƒ.
2.  `TelegramBotService`ê°€ ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ "ğŸš€ SOXL ë§¤ìˆ˜ ì£¼ë¬¸ ì „ì†¡ ì™„ë£Œ (LOC 15.2$)" ë©”ì‹œì§€ ì „ì†¡.
3.  ì‚¬ìš©ìê°€ í…”ë ˆê·¸ë¨ì— `/status` ì…ë ¥.
4.  `TelegramBotService`ê°€ ìˆ˜ì‹  -> `MessageHandler` í˜¸ì¶œ -> í˜„ì¬ ìƒíƒœ í¬ë§·íŒ… í›„ ì‘ë‹µ ì „ì†¡.

---
ê¸°ì¡´ì˜ `InfiniteBuyingStrategy` í´ë˜ìŠ¤ëŠ” API í˜¸ì¶œ, ìƒíƒœ ê´€ë¦¬, ì•Œë¦¼ ë¡œì§ì´ ë’¤ì„ì—¬ ìˆì–´ í…ŒìŠ¤íŠ¸ì™€ í™•ì¥ì´ ë¶ˆê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤.
Revised ë²„ì „ì—ì„œëŠ” **Core Business Logic**ì„ ìˆœìˆ˜ Python ì½”ë“œë¡œ ë…ë¦½ì‹œí‚µë‹ˆë‹¤. ì´ ê³„ì¸µì€ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬(KIS Api, Telegram ë“±)ì— ì „í˜€ ì˜ì¡´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.---

## 4. Presentation Layer (`src_rev/presentation`)

**Decoupled Architecture**ë¥¼ ì±„íƒí•˜ì—¬, UIì™€ ì‹¤í–‰ ì—”ì§„ì„ ì™„ì „íˆ ë¶„ë¦¬í•©ë‹ˆë‹¤.
*   **ì‹¤í–‰ ì—”ì§„**: `python main_rev.py` (Write Only)
*   **UI**: `streamlit run src_rev/presentation/dashboard.py` (Read Only)

```bash
src_rev/presentation/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ dashboard.py    # Streamlit ë©”ì¸ ëŒ€ì‹œë³´ë“œ
â””â”€â”€ view_models.py  # UI í‘œì‹œìš© ë°ì´í„° ë³€í™˜ ë¡œì§
```

### ë°ì´í„° íë¦„
1.  `TradingEngine`ì´ ì‘ì—… ìˆ˜í–‰ í›„ `CycleState`ë¥¼ `revised_state.json`ì— ì €ì¥.
2.  `Dashboard`ëŠ” `st.rerun()` ë˜ëŠ” ì£¼ê¸°ì  í´ë§ìœ¼ë¡œ JSON íŒŒì¼ì„ ì½ìŒ.
3.  ì½ì€ ë°ì´í„°ë¥¼ ì‹œê°í™”í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ í‘œì‹œ. (ì§ì ‘ ë³€ìˆ˜ ê³µìœ  ì—†ìŒ)

### ì£¼ìš” ê¸°ëŠ¥
*   **ìƒíƒœ ìš”ì•½**: í˜„ì¬ ì‚¬ì´í´ ì§„í–‰ë¥ , ëˆ„ì  ìˆ˜ìµ, ì˜¤ëŠ˜ ë§¤ìˆ˜ ì—¬ë¶€ í‘œì‹œ.
*   **ë¡œê·¸ ë·°ì–´**: (ì„ íƒ) ë¡œê·¸ íŒŒì¼ì„ ì½ì–´ í™”ë©´ì— í‘œì‹œ.

---

## 5. íŒ¨í‚¤ì§€ êµ¬ì¡° (`src_rev/domain`)

```bash
src_rev/domain/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ common.py           # ê³µí†µ Value Object (Money, Quantity ë“±)
â”œâ”€â”€ models.py           # í•µì‹¬ ì—”í‹°í‹° (Position, Order, Account)
â””â”€â”€ strategies/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ base.py         # ì „ëµ ì¸í„°í˜ì´ìŠ¤
    â””â”€â”€ infinite.py     # ë¬´í•œë§¤ìˆ˜ ì „ëµ ìˆœìˆ˜ ë¡œì§ (Dr. Laor's Logic)
```

## 4. í•µì‹¬ í´ë˜ìŠ¤ ì„¤ê³„

### A. Value Objects & Models (`models.py`)

1.  **`OrderType` (Enum)**
    *   `LOC`: Limit on Close (ì¢…ê°€ ì§€ì •ê°€)
    *   `AFTER_MARKET`: ì• í”„í„°ë§ˆì¼“ ì§€ì •ê°€
    *   `LIMIT`: ì¼ë°˜ ì§€ì •ê°€
    *   `MARKET`: ì‹œì¥ê°€

2.  **`Position` (Dataclass)**
    *   `symbol`: str
    *   `quantity`: int
    *   `avg_price`: float
    *   `current_price`: float (ì‹œì¥ê°€ ì—…ë°ì´íŠ¸ìš©)
    *   property `total_cost`: quantity * avg_price

3.  **`Order` (Dataclass)**
    *   `symbol`: str
    *   `side`: Literal['BUY', 'SELL']
    *   `price`: float
    *   `quantity`: int
    *   `order_type`: OrderType
    *   `description`: str (ì˜ˆ: "Star ê°€ê²© ë§¤ìˆ˜", "ìµì ˆ ë§¤ë„")

### B. Infinite Buying Logic (`strategies/infinite.py`)

ì´ í´ë˜ìŠ¤ëŠ” ìƒíƒœë¥¼ ì§ì ‘ ì €ì¥í•˜ì§€ ì•Šê³ , ì…ë ¥ê°’(ì„¤ì •, í˜„ì¬ í¬ì§€ì…˜)ì„ ë°›ì•„ì„œ ê²°ê³¼ê°’(ì£¼ë¬¸ ëª©ë¡, ê³„ì‚° ê²°ê³¼)ì„ ë°˜í™˜í•˜ëŠ” **Pure Component**ì— ê°€ê¹ê²Œ ì„¤ê³„í•©ë‹ˆë‹¤.

*   **ì…ë ¥ (Inputs)**:
    *   `InfiniteConfig` (ì´íˆ¬ìê¸ˆ, ë¶„í• ìˆ˜, ìµì ˆë¥  ë“±)
    *   `Position` (í˜„ì¬ ë³´ìœ  ìˆ˜ëŸ‰, í‰ë‹¨ê°€)
    *   `MarketData` (í˜„ì¬ê°€ ë“±)

*   **ì¶œë ¥ (Outputs)**:
    *   `StrategyDecision`:
        *   `buy_orders`: List[Order]
        *   `sell_orders`: List[Order]
        *   `metrics`: Dict (í˜„ì¬ ì§„í–‰ìœ¨, Star ê°€ê²©, ëª©í‘œ ìµì ˆê°€ ë“± - UI í‘œì‹œìš©)

*   **í•µì‹¬ ë¡œì§ ë¶„ë¦¬**:
    1.  `calculate_metrics(...)`: T(íšŒì°¨), ì§„í–‰ë¥ , Starê°€ê²©, ìµì ˆê°€ê²© ê³„ì‚°
    2.  `generate_buy_orders(...)`: T <= 20 vs T > 20 ë¶„ê¸° ì²˜ë¦¬, ì¶”ê°€ ë§¤ìˆ˜(ë¬¼íƒ€ê¸°) ë¡œì§
    3.  `generate_sell_orders(...)`: Star ë§¤ë„(1/4), ìµì ˆ ë§¤ë„(ì „ëŸ‰) ë¡œì§

## 6. í…ŒìŠ¤íŠ¸ ê³„íš (Test Spec)

`test/unit/domain/test_infinite.py`ë¥¼ ì‘ì„±í•˜ì—¬ ë‹¤ìŒ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤.

1.  **ì´ˆê¸° ìƒíƒœ (T=0)**
    *   ë³´ìœ  ìˆ˜ëŸ‰ 0ì¼ ë•Œ: 1íšŒì°¨ ë§¤ìˆ˜ ì£¼ë¬¸(Star ë§¤ìˆ˜ + í‰ë‹¨ ë§¤ìˆ˜)ì´ ì •ìƒ ìƒì„±ë˜ëŠ”ê°€?
2.  **ì§„í–‰ ì¤‘ (T <= 20)**
    *   Star ê°€ê²©ê³¼ í‰ë‹¨ ë§¤ìˆ˜ ìˆ˜ëŸ‰ì´ ê³µì‹ëŒ€ë¡œ ê³„ì‚°ë˜ëŠ”ê°€?
    *   LOC ì£¼ë¬¸ íƒ€ì…ì´ ì„¤ì •ë˜ëŠ”ê°€?
3.  **í›„ë°˜ì „ (T > 20)**
    *   í‰ë‹¨ ë§¤ìˆ˜ ì—†ì´ Star ê°€ê²©ì— ì „ì•¡ ë§¤ìˆ˜í•˜ëŠ”ê°€?
4.  **ë§¤ë„ ì¡°ê±´**
    *   ìµì ˆ êµ¬ê°„ ë„ë‹¬ ì‹œ ë§¤ë„ ì£¼ë¬¸(After Market)ì´ ìƒì„±ë˜ëŠ”ê°€?
    *   Star ë§¤ë„(1/4) ë¡œì§ì´ ì‘ë™í•˜ëŠ”ê°€?

---
## 7. ë‹¤ìŒ ë‹¨ê³„ (Approval)
ì´ ê³„íšì´ ìŠ¹ì¸ë˜ë©´ `src_rev/domain` ë‚´ë¶€ ì½”ë“œ ì‘ì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤.
