#!/usr/bin/env python3
"""
ê±°ë˜ë‚´ì—­ í…Œì´ë¸” í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

Usage:
    python test_trade_history.py
"""

import sys
import os
from datetime import datetime, timedelta

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from src.strategy.trade_history import TradeHistory
from src.config import Config


def test_trade_history_table():
    """ê±°ë˜ë‚´ì—­ í…Œì´ë¸” í…ŒìŠ¤íŠ¸"""
    print("ğŸ§ª ê±°ë˜ë‚´ì—­ í…Œì´ë¸” í…ŒìŠ¤íŠ¸ ì‹œì‘")
    
    # ê°€ìƒ ì„¤ì • ìƒì„±
    mock_params = {
        "total_investment": 1000000,  # 100ë§Œì›
        "division_count": 40,
        "max_profit_rate": 12,
        "min_profit_rate": 8,
        "star_adjustment_rate": 0
    }
    
    # TradeHistory ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)
    trade_history = TradeHistory(
        kis_client=None,  # í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œëŠ” ë¶ˆí•„ìš”
        symbol="SOXL",
        strategy_params=mock_params,
        test_mode=True  # í…ŒìŠ¤íŠ¸ ëª¨ë“œ í™œì„±í™”
    )
    
    # 30ì¼ê°„ì˜ ê±°ë˜ë‚´ì—­ í…Œì´ë¸” ìƒì„±
    print("\nğŸ“Š 30ì¼ê°„ ê±°ë˜ë‚´ì—­ í…Œì´ë¸” ìƒì„± ì¤‘...")
    start_date = (datetime.now() - timedelta(days=30)).date()
    
    df = trade_history.get_trading_history_table(days=30)
    
    if df.empty:
        print("âŒ í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨ - ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return False
    
    print(f"âœ… í…Œì´ë¸” ìƒì„± ì„±ê³µ! ì´ {len(df)}í–‰ì˜ ë°ì´í„°")
    print("\nğŸ“‹ ê±°ë˜ë‚´ì—­ í…Œì´ë¸” (ìƒìœ„ 10í–‰):")
    print("=" * 120)
    print(df.head(10).to_string(index=False))
    print("=" * 120)
    
    # í…Œì´ë¸” ì»¬ëŸ¼ í™•ì¸
    expected_columns = [
        "Date", "Close", "í‰ë‹¨ê°€", "Starê°€ê²©", "ìˆ˜ëŸ‰", 
        "ìˆ˜ëŸ‰ë³€ë™", "ì‹¤í˜„ì†ìµ($)", "ëˆ„ì ì†ìµ($)", 
        "ëˆ„ì íˆ¬ìì•¡($)", "ë‹¹ì¼íˆ¬ìì•¡($)", "ì”ê³ ìˆ˜ìµë¥ "
    ]
    
    print(f"\nğŸ” ì»¬ëŸ¼ í™•ì¸:")
    for col in expected_columns:
        if col in df.columns:
            print(f"  âœ… {col}")
        else:
            print(f"  âŒ {col} (ëˆ„ë½)")
    
    # ë°ì´í„° í†µê³„
    print(f"\nğŸ“ˆ ë°ì´í„° í†µê³„:")
    print(f"  - ì „ì²´ í–‰ìˆ˜: {len(df)}")
    print(f"  - ë‚ ì§œ ë²”ìœ„: {df['Date'].min()} ~ {df['Date'].max()}")
    
    # ìˆ˜ëŸ‰ ë³€ë™ í™•ì¸
    quantity_changes = df[df['ìˆ˜ëŸ‰ë³€ë™'] != '']
    if not quantity_changes.empty:
        print(f"  - ê±°ë˜ ë°œìƒì¼: {len(quantity_changes)}ì¼")
        print(f"  - ìµœì¢… ë³´ìœ ìˆ˜ëŸ‰: {df.iloc[0]['ìˆ˜ëŸ‰'] if not df.empty else 0}ì£¼")
    
    # ì†ìµ ì •ë³´
    profit_data = df[df['ëˆ„ì ì†ìµ($)'] != '']
    if not profit_data.empty:
        print(f"  - ì†ìµ ê¸°ë¡ì¼: {len(profit_data)}ì¼")
        latest_profit = profit_data.iloc[0]['ëˆ„ì ì†ìµ($)'] if not profit_data.empty else "N/A"
        print(f"  - ìµœì‹  ëˆ„ì ì†ìµ: {latest_profit}")
    
    return True


def test_with_config():
    """ì„¤ì • íŒŒì¼ì„ ì´ìš©í•œ í…ŒìŠ¤íŠ¸"""
    print("\nğŸ”§ ì„¤ì • íŒŒì¼ ê¸°ë°˜ í…ŒìŠ¤íŠ¸")
    
    try:
        # ì„¤ì • ë¡œë“œ
        config = Config()
        strategy_config = config.trading.get("infinite_buying_strategy", {})
        
        # í…ŒìŠ¤íŠ¸ ëª¨ë“œ ìƒíƒœ í™•ì¸
        test_mode = strategy_config.get("trade_history_test_mode", False)
        print(f"ğŸ“‹ í˜„ì¬ ì„¤ì •ì˜ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: {test_mode}")
        
        if test_mode:
            print("âœ… í…ŒìŠ¤íŠ¸ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
            print("ğŸ’¡ ì‹¤ì œ ì „ëµì—ì„œë„ ê°€ìƒ ê±°ë˜ë‚´ì—­ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.")
        else:
            print("ğŸ“Š í…ŒìŠ¤íŠ¸ ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
            print("ğŸ’¡ ì‹¤ì œ ì „ëµì—ì„œëŠ” ì‹¤ì œ APIë¥¼ í†µí•´ ê±°ë˜ë‚´ì—­ì„ ì¡°íšŒí•©ë‹ˆë‹¤.")
            print("ğŸ’¡ í…ŒìŠ¤íŠ¸ë¥¼ ì›í•˜ë©´ config.yamlì—ì„œ trade_history_test_mode: trueë¡œ ì„¤ì •í•˜ì„¸ìš”.")
        
        return True
        
    except Exception as e:
        print(f"âŒ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: {str(e)}")
        return False


if __name__ == "__main__":
    print("ğŸ¯ SOXL ë¬´í•œë§¤ìˆ˜ ì „ëµ - ê±°ë˜ë‚´ì—­ í…Œì´ë¸” í…ŒìŠ¤íŠ¸")
    print("=" * 60)
    
    # ê¸°ë³¸ í…ŒìŠ¤íŠ¸
    success1 = test_trade_history_table()
    
    # ì„¤ì • íŒŒì¼ í…ŒìŠ¤íŠ¸
    success2 = test_with_config()
    
    print("\n" + "=" * 60)
    if success1 and success2:
        print("ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
        print("\nğŸ“ ì‚¬ìš©ë²•:")
        print("1. config.yamlì—ì„œ trade_history_test_mode: trueë¡œ ì„¤ì •")
        print("2. ì „ëµ ì‹¤í–‰ ì‹œ ê°€ìƒ ê±°ë˜ë‚´ì—­ìœ¼ë¡œ í…Œì´ë¸” í™•ì¸ ê°€ëŠ¥")
        print("3. UIì—ì„œ ê±°ë˜ë‚´ì—­ íƒ­ í™•ì¸")
    else:
        print("âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        sys.exit(1) 